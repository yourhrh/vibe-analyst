# Vide Analyst - C4 Context Diagram

> 미국 주식 종합 분석 플랫폼.
> 티커 하나를 입력하면 재무데이터·뉴스·산업 정보를 수집하여,
> 전설적 투자자 관점의 리포트와 정량 밸류에이션을 한국어로 제공한다.
>
> **운영 제약: 월 $0 (모든 서비스 Free Tier)**

---

## 1. Context Overview

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  USERS                                          │
│                                                                                 │
│    👤 개인투자자              👤 준전문투자자            👤 입문투자자              │
│    시간 없이 빠르게           슬라이더로 가정치 조정      쉬운 한국어 해설로          │
│    종합 리포트를 원한다       나만의 밸류에이션을 원한다   투자 프레임워크를 배운다     │
│                                                                                 │
└──────────────────────────────────────┬──────────────────────────────────────────┘
                                       │
                                       │ HTTPS (vercel.app)
                                       ▼
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                                                                                 ┃
┃                         Vide Analyst Platform                                   ┃
┃                         [Software System]                                       ┃
┃                                                                                 ┃
┃  Next.js 15 모노리스 (Vercel Hobby Free)                                        ┃
┃  ┌──────────────────────────────────────────────────────────────────────┐       ┃
┃  │                                                                      │       ┃
┃  │  브라우저 (오케스트레이터)                                             │       ┃
┃  │  └─ 10단계 순차 API 호출로 분석을 지휘                                │       ┃
┃  │     각 스텝 < 30초 → Vercel 60초 타임아웃 회피                        │       ┃
┃  │                                                                      │       ┃
┃  │  서버 (API Routes)                                                   │       ┃
┃  │  ├─ Node.js Runtime: 데이터 수집, 캐시 R/W                           │       ┃
┃  │  └─ Edge Runtime: LLM 스트리밍 (최대 300초)                           │       ┃
┃  │                                                                      │       ┃
┃  │  밸류에이션 엔진 (순수 TypeScript)                                    │       ┃
┃  │  └─ DCF / RIM / Comparable — LLM이 아닌 코드로 계산                   │       ┃
┃  │                                                                      │       ┃
┃  └──────────────────────────────────────────────────────────────────────┘       ┃
┃                                                                                 ┃
┗━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
        │           │           │          │
        ▼           ▼           ▼          ▼
  ┌───────────┐┌───────────┐┌────────┐┌───────────┐
  │ Financial ││   News    ││  LLM   ││ Database  │
  │   Data    ││           ││ Engine ││  & Auth   │
  │           ││           ││        ││           │
  │ FMP Free  ││ Finnhub   ││ Google ││ Supabase  │
  │ + EDGAR   ││ Free      ││ Gemini ││ Free      │
  │[External] ││[External] ││[Extern]││[External] │
  └───────────┘└───────────┘└────────┘└───────────┘
```

---

## 2. External Systems

### 2.1 Financial Data — FMP Free + SEC EDGAR

이 두 소스를 조합해 재무 데이터의 폭과 깊이를 모두 확보한다.

```
┌──────────────────────────────────────────────────────────────┐
│  Financial Data Layer                                        │
│                                                              │
│  ┌──────────────────────────────┐  ┌──────────────────────┐ │
│  │  Financial Modeling Prep     │  │  SEC EDGAR            │ │
│  │  (FMP Free Tier)             │  │  (완전 무료 공공 API)  │ │
│  │                              │  │                       │ │
│  │  제한: 250 requests/day      │  │  제한: 10 req/sec     │ │
│  │  인증: API Key (무료 발급)    │  │  인증: User-Agent만   │ │
│  │                              │  │                       │ │
│  │  제공 데이터:                 │  │  제공 데이터:          │ │
│  │  ├─ Company Profile          │  │  ├─ XBRL 재무데이터   │ │
│  │  ├─ Income Statement (5yr)   │  │  ├─ 10-K (연간보고서) │ │
│  │  ├─ Balance Sheet (5yr)      │  │  ├─ 10-Q (분기보고서) │ │
│  │  ├─ Cash Flow Statement (5yr)│  │  ├─ 8-K (수시공시)   │ │
│  │  ├─ Financial Ratios         │  │  └─ Company Facts    │ │
│  │  ├─ Stock Quote (현재가)      │  │      (CIK 기반)      │ │
│  │  ├─ Historical Prices        │  │                       │ │
│  │  └─ Peers List               │  │  역할:                │ │
│  │                              │  │  FMP 할당량 초과 시   │ │
│  │  역할:                        │  │  1차 폴백 소스.       │ │
│  │  정형 재무 데이터의 1차 소스.  │  │  리스크 팩터(Item 1A) │ │
│  │  프로필, 시세, 비율 등        │  │  같은 비정형 데이터도 │ │
│  │  편의 데이터 제공.            │  │  여기서 추출.         │ │
│  │                              │  │                       │ │
│  └──────────────────────────────┘  └──────────────────────┘ │
│                                                              │
│  1회 분석 시 FMP ~8 requests 소비                             │
│  일일 용량: ~31 고유 종목 (캐시 HIT 시 0 소비)                │
│                                                              │
│  용도:                                                       │
│  ├─ 종합 리포트의 재무 요약 섹션                              │
│  ├─ 투자 대가 체크리스트의 정량 항목 (ROE, PER, 부채비율 등)  │
│  ├─ DCF/RIM 모델의 입력 데이터                                │
│  ├─ 경쟁사 비교 분석                                         │
│  └─ 현재가 vs 적정주가 비교                                   │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 News — Finnhub Free

```
┌──────────────────────────────────────────────────────────────┐
│  Finnhub News API                                            │
│  [External System]                                           │
│                                                              │
│  제한: 60 calls/min (Free Tier)                              │
│  인증: API Key (무료 발급)                                    │
│                                                              │
│  제공 데이터:                                                 │
│  ├─ 종목별 최신 뉴스 (최근 30일)                              │
│  ├─ 헤드라인 + 요약 + 소스 + URL                              │
│  ├─ 발행일시                                                 │
│  └─ 카테고리 태그                                             │
│                                                              │
│  우리 시스템에서의 처리:                                       │
│  ├─ LLM이 뉴스를 분석 → 긍정/부정/중립 분류                   │
│  ├─ LLM이 주가 영향도 판단 (High / Medium / Low)              │
│  └─ 종합 리포트와 투자자 분석의 "최신 이벤트" 컨텍스트로 주입  │
│                                                              │
│  용도:                                                       │
│  ├─ 종합 리포트의 뉴스 & 이벤트 섹션                          │
│  ├─ 투자 대가 분석의 최근 동향 반영                           │
│  └─ (향후) 뉴스 인텔리전스 탭의 센티먼트 차트                  │
└──────────────────────────────────────────────────────────────┘
```

### 2.3 LLM Engine — Google Gemini (LLMPort 추상화)

```
┌──────────────────────────────────────────────────────────────┐
│  Google Gemini via LLMPort (REST API 직접 호출)               │
│  [External System — 가장 핵심적인 의존성]                      │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Gemini 2.5 Flash  (메인 모델)                        │   │
│  │  제한: 10 RPM, 250 RPD, 250K TPM                     │   │
│  │  용도: 종합 리포트, 투자자 6인 분석, 밸류에이션 가정치  │   │
│  ├──────────────────────────────────────────────────────┤   │
│  │  Gemini 2.5 Flash-Lite  (경량 모델)                   │   │
│  │  제한: 15 RPM, 1K RPD, 250K TPM                      │   │
│  │  용도: 뉴스 요약, 검색 보조 등 단순 작업               │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  왜 Gemini인가:                                              │
│  ├─ 무료 tier가 가장 넉넉 (일 250회, 분당 10회)              │
│  ├─ 한국어 품질 양호                                         │
│  └─ LLMPort 추상화로 어댑터 교체만으로                        │
│     Claude / GPT-4o 등으로 즉시 전환 가능 (SDK 의존 없음)    │
│                                                              │
│  역할 (LLM이 하는 것):                                       │
│  ├─ 투자 대가 관점 리포트 생성 (각 대가별 시스템 프롬프트)    │
│  ├─ 재무제표 해석 및 한국어 요약                              │
│  ├─ 뉴스 센티먼트 분석 & 영향도 판단                         │
│  ├─ 밸류에이션 가정치 추론 + 근거 설명                        │
│  └─ 영문 원본 데이터 → 한국어 맥락 변환                      │
│                                                              │
│  역할 (LLM이 하지 않는 것):                                   │
│  └─ DCF/RIM 수치 계산 → 순수 TypeScript가 처리 (정확도 보장) │
│                                                              │
│  아키텍처 패턴:                                               │
│  ├─ Structured Output (JSON mode) → 정형 분석 결과           │
│  ├─ System Prompt 분리 → 투자자별 페르소나                   │
│  ├─ Context Injection → 수집된 재무+뉴스 데이터를 프롬프트에  │
│  └─ Edge Streaming → 실시간 글 작성 UX                       │
│                                                              │
│  1회 전체 분석 = 8 LLM 호출:                                 │
│  ├─ 종합 리포트          ×1                                  │
│  ├─ 투자자 분석          ×6 (버핏,그레이엄,린치,달리오,       │
│  │                           그린블랫,피셔)                   │
│  └─ 밸류에이션 가정치     ×1                                  │
│                                                              │
│  일일 용량: 250 RPD ÷ 8 = ~31회 전체 분석                    │
│  분당 속도: 순차 실행으로 자연스럽게 10 RPM 이내 유지          │
└──────────────────────────────────────────────────────────────┘
```

### 2.4 Database & Auth — Supabase Free

```
┌──────────────────────────────────────────────────────────────┐
│  Supabase Free Tier                                          │
│  [External System — DB + Auth + 캐시 통합]                    │
│                                                              │
│  제한: 500MB DB, 1GB storage, 50K MAU                        │
│  별도 Redis 불필요 — PostgreSQL JSONB로 캐시 역할도 수행      │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  PostgreSQL                                          │   │
│  │                                                      │   │
│  │  financial_data_cache                                │   │
│  │  └─ FMP/EDGAR/Finnhub 응답을 JSONB로 캐시            │   │
│  │     TTL: 재무 24h, 뉴스 1h, 시세 5min, 프로필 7d     │   │
│  │     → 동일 종목 재조회 시 API 호출 0건               │   │
│  │                                                      │   │
│  │  analyses                                            │   │
│  │  └─ 완성된 분석 결과 캐시 (24h TTL)                   │   │
│  │     리포트 텍스트 + 투자자 분석 + 밸류에이션 결과      │   │
│  │     → 같은 종목 24시간 내 재요청 시 즉시 반환         │   │
│  │                                                      │   │
│  │  profiles / watchlist / analysis_events               │   │
│  │  └─ 사용자 데이터, 워치리스트, 트렌딩 집계용          │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Supabase Auth                                       │   │
│  │  └─ Google OAuth (향후)                               │   │
│  │     워치리스트 저장, 분석 히스토리, 사용량 추적에 사용  │   │
│  │     MVP에서는 비로그인 상태로도 분석 가능              │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  자동정지 방지                                        │   │
│  │  └─ Vercel Cron (1개 무료)이 매일 keep-alive 쿼리     │   │
│  │     Supabase Free는 7일 미사용 시 자동 정지되므로 필수 │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  용량 추정: ~120MB (500종목 캐시) → 500MB 한도 내 충분       │
│                                                              │
│  RLS(Row Level Security) 적용:                                │
│  ├─ 분석 결과/캐시 → 누구나 읽기 가능 (공개)                 │
│  ├─ 워치리스트/프로필 → 본인만 접근                           │
│  └─ 쓰기 → service_role 키로 서버에서만                      │
└──────────────────────────────────────────────────────────────┘
```

---

## 3. Data Flow — 1회 분석 요청 시 (클라이언트 오케스트레이션)

핵심 아키텍처 결정: **브라우저가 지휘자**.
단일 긴 서버 호출이 아닌, 10단계 순차 API 호출로 분할하여
Vercel 60초 타임아웃을 회피하고, 단계별 진행 UI를 자연스럽게 구현한다.

```
사용자: "AAPL 분석해줘"
         │
         ▼
┌──────────────────────────────────────────────────────────────────┐
│  Browser (분석 오케스트레이터)                                     │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ Step 0: 캐시 확인                                          │ │
│  │ GET /api/cache/AAPL                                        │ │
│  │ └─ HIT → 즉시 표시 (분석 종료)                              │ │
│  │ └─ MISS → Step 1로                                         │ │
│  └───────────────────────────────┬────────────────────────────┘ │
│                                  ▼                               │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ Step 1: 데이터 수집 (Node.js, 5~15초)                      │ │
│  │ POST /api/analyze/collect { ticker: "AAPL" }               │ │
│  │                                                            │ │
│  │    ┌──────┐ ┌──────┐ ┌───────┐                            │ │
│  │    │ FMP  │ │EDGAR │ │Finnhub│  ← 3개 소스 병렬 호출       │ │
│  │    │재무  │ │XBRL  │ │뉴스   │                             │ │
│  │    └──┬───┘ └──┬───┘ └──┬────┘                            │ │
│  │       └────────┼────────┘                                  │ │
│  │                ▼                                            │ │
│  │    Data Aggregation Layer                                   │ │
│  │    ├─ 정규화, 정제                                          │ │
│  │    ├─ LLM 컨텍스트 문자열 구성 (~4K tokens)                 │ │
│  │    └─ Supabase에 캐시 저장                                  │ │
│  │                                                            │ │
│  │ 응답: { analysisId, context, contextString }               │ │
│  │ UI: ✅ "재무 데이터 수집 완료 — 매출 $394B, 영업이익률 30.7%"│ │
│  └───────────────────────────────┬────────────────────────────┘ │
│                                  ▼                               │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ Step 2: 종합 리포트 (Edge, 스트리밍, 15~25초)               │ │
│  │ POST /api/analyze/report                                   │ │
│  │                                                            │ │
│  │    Gemini 2.5 Flash                                        │ │
│  │    ├─ System: "재무 애널리스트, 한국어로 분석"               │ │
│  │    ├─ Context: 수집된 재무+뉴스 데이터                      │ │
│  │    └─ Output: 종합 리포트 마크다운 (스트리밍)                │ │
│  │                                                            │ │
│  │ UI: 실시간으로 리포트 텍스트가 타이핑되듯 나타남              │ │
│  └───────────────────────────────┬────────────────────────────┘ │
│                                  ▼                               │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ Steps 3~8: 투자 대가 분석 ×6 (Edge, 각 15~20초, 순차)      │ │
│  │ POST /api/analyze/investor/{id}                            │ │
│  │                                                            │ │
│  │    ┌─────────┐ → ┌─────────┐ → ┌─────────┐               │ │
│  │    │ Buffett │   │ Graham  │   │  Lynch  │               │ │
│  │    └─────────┘   └─────────┘   └─────────┘               │ │
│  │    ┌─────────┐ → ┌─────────┐ → ┌─────────┐               │ │
│  │    │  Dalio  │   │Greenbl. │   │ Fisher  │               │ │
│  │    └─────────┘   └─────────┘   └─────────┘               │ │
│  │                                                            │ │
│  │    각 투자자별 전용 시스템 프롬프트로 개별 LLM 호출          │ │
│  │    순차 실행 → 자연스럽게 10 RPM 준수                       │ │
│  │                                                            │ │
│  │ UI: 각 투자자 카드가 하나씩 완성되며 나타남                  │ │
│  │     "버핏 분석 완료... 그레이엄 분석 중..."                  │ │
│  └───────────────────────────────┬────────────────────────────┘ │
│                                  ▼                               │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ Step 9: 밸류에이션 (Edge, 스트리밍+계산, 15~20초)           │ │
│  │ POST /api/analyze/valuation                                │ │
│  │                                                            │ │
│  │    ① LLM → 가정치 추론 (성장률, WACC, 마진 등) + 근거 설명 │ │
│  │    ② TypeScript → DCF / RIM / Comparable 수치 계산          │ │
│  │       (LLM이 아닌 코드가 계산 → 숫자 정확도 보장)           │ │
│  │    ③ 결과: 적정주가 레인지 + 시나리오별 가격                │ │
│  │                                                            │ │
│  │ UI: 적정주가 레인지 차트 + 인터랙티브 슬라이더 표시          │ │
│  │     슬라이더 조정 → TypeScript 재계산만 (LLM 재호출 없음)   │ │
│  └───────────────────────────────┬────────────────────────────┘ │
│                                  ▼                               │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ Step 10: 결과 저장 (Node.js, <3초)                         │ │
│  │ POST /api/analyze/save                                     │ │
│  │ └─ 전체 분석 결과를 Supabase에 캐시 (24h TTL)               │ │
│  │   동일 종목 재요청 시 Step 0에서 즉시 반환                   │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  총 소요: 약 2~3분 (체감 시간은 단계별 UI로 훨씬 짧게 느껴짐)     │
│  총 LLM 호출: 8회 (리포트1 + 투자자6 + 밸류에이션1)              │
│  총 FMP 호출: ~8회 (캐시 HIT 시 0)                               │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 4. 시스템 간 관계 요약

```
┌────────────┐      조회/캐시 R/W      ┌──────────────┐
│            │◄────────────────────────►│              │
│   Vide     │                          │   Supabase   │
│   Analyst  │      Auth (향후)         │   Free       │
│   Platform │◄────────────────────────►│  PostgreSQL  │
│            │                          │  + Auth      │
│  (Next.js  │                          └──────────────┘
│   Vercel)  │
│            │      재무 데이터          ┌──────────────┐
│            │─────────────────────────►│ FMP Free     │
│            │      250 req/day         │ (API Key)    │
│            │                          └──────────────┘
│            │
│            │      XBRL / 공시         ┌──────────────┐
│            │─────────────────────────►│ SEC EDGAR    │
│            │      무제한 (10 r/s)      │ (User-Agent) │
│            │                          └──────────────┘
│            │
│            │      종목 뉴스           ┌──────────────┐
│            │─────────────────────────►│ Finnhub Free │
│            │      60 calls/min        │ (API Key)    │
│            │                          └──────────────┘
│            │
│            │      LLM 스트리밍        ┌──────────────┐
│            │─────────────────────────►│ Google       │
│            │      8 calls/분석        │ Gemini 2.5   │
│            │      10 RPM, 250 RPD     │ Flash (Free) │
└────────────┘                          └──────────────┘
```

---

## 5. 비용 추정

| 항목 | 월 비용 | Free Tier 한도 |
|------|:------:|---------------|
| Vercel Hobby | $0 | 100GB BW, 서버리스 60s, Edge 30s |
| Supabase Free | $0 | 500MB DB, 50K MAU, 1GB storage |
| Google Gemini | $0 | 10 RPM, 250 RPD, 250K TPM |
| FMP Free | $0 | 250 requests/day |
| Finnhub Free | $0 | 60 calls/min |
| SEC EDGAR | $0 | 무제한 (공공 API) |
| **합계** | **$0** | **일 ~31회 전체 분석 가능** |

---

## 6. 핵심 아키텍처 결정

| 결정 사항 | 선택 | 이유 |
|----------|------|------|
| **클라이언트 vs 서버 오케스트레이션** | 클라이언트 (브라우저) | Vercel 60초 타임아웃 회피. 각 스텝이 독립 API 호출 |
| **Edge vs Node.js** | LLM 라우트 = Edge, 데이터 = Node.js | Edge는 스트리밍 최대 300초. 데이터 수집은 Node.js API 필요 |
| **LLM 선택** | Gemini 2.5 Flash (Free) | 무료 중 가장 넉넉. AI SDK로 provider 교체 1줄 |
| **투자자 분석 실행** | 순차 (병렬 아님) | 10 RPM 자연 준수. 에러 처리 단순화. 단계별 UX에 부합 |
| **밸류에이션 계산** | TypeScript (코드) | LLM은 가정치만 추론. 수치 계산은 코드 → 정확도 보장 |
| **캐싱** | Supabase JSONB | Redis 없이 PostgreSQL로 통합. 서비스 하나 줄임 |
| **인증** | Supabase Auth (MVP 후반) | DB와 통합. MVP 초기에는 비로그인도 분석 가능 |
| **모노리스 vs MSA** | Next.js 모노리스 | MVP 복잡도 최소화 |
| **캐시 TTL** | 재무 24h, 뉴스 1h, 시세 5min | API 비용(호출수)과 데이터 신선도의 균형 |
| **다국어** | LLM이 한국어로 직접 출력 | 별도 번역 레이어 불필요 |

---

## 7. 제약과 트레이드오프

### 무료 tier로 인한 한계

| 제약 | 영향 | 대응 |
|------|------|------|
| Gemini 250 RPD | 일 ~31회 전체 분석으로 제한 | 적극적 캐싱. 테스트 프로젝트에는 충분 |
| FMP 250 req/day | 일 ~31 고유 종목 | Supabase에 24h 캐시. EDGAR를 폴백 |
| Vercel 60초 timeout | 단일 API로 전체 분석 불가 | 클라이언트 오케스트레이션으로 해결 |
| Supabase 500MB | 캐시 데이터 규모 제한 | TTL 기반 자동 정리. ~120MB로 충분 |
| Supabase 7일 자동정지 | 미사용 시 서비스 중단 | Vercel cron keep-alive |
| Gemini 품질 vs Claude/GPT | 분석 깊이가 다소 낮을 수 있음 | 프롬프트 튜닝 + 향후 유료 전환 시 1줄 교체 |

### 확장 경로 (유료 전환 시)

```
$0/월 (현재)                    $30~100/월 (확장)
───────────────                 ─────────────────
Gemini Free          →          Claude Sonnet / GPT-4o
FMP Free (250/day)   →          FMP Starter ($29, 무제한)
Supabase Free        →          Supabase Pro ($25)
Vercel Hobby         →          Vercel Pro ($20)

provider.ts 1줄 수정만으로 LLM 교체 가능
나머지는 환경변수 + 플랜 업그레이드만으로 전환
```
