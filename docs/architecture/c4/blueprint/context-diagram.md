# Vide Analyst - C4 Context Diagram (Blueprint)

> **이 문서는 청사진(목표 아키텍처)입니다.**
> 현재 구현 상태는 [current/implementation-status.md](../current/implementation-status.md)를 참고하세요.

---

> 미국 주식 종합 분석 플랫폼.
> 티커 하나를 입력하면 재무데이터·뉴스·산업 정보를 수집하여,
> 전설적 투자자 관점의 리포트와 정량 밸류에이션을 한국어로 제공한다.
>
> **운영 제약: 월 $0 (모든 서비스 Free Tier)**

---

## 1. Context Overview

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  USERS                                          │
│                                                                                 │
│    👤 개인투자자              👤 준전문투자자            👤 입문투자자              │
│    시간 없이 빠르게           슬라이더로 가정치 조정      쉬운 한국어 해설로          │
│    종합 리포트를 원한다       나만의 밸류에이션을 원한다   투자 프레임워크를 배운다     │
│                                                                                 │
└──────────────────────────────────────┬──────────────────────────────────────────┘
                                       │
                                       │ HTTPS (vercel.app)
                                       ▼
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                                                                                 ┃
┃                         Vide Analyst Platform                                   ┃
┃                         [Software System]                                       ┃
┃                                                                                 ┃
┃  Next.js 15 모노리스 (Vercel Hobby Free)                                        ┃
┃  ┌──────────────────────────────────────────────────────────────────────┐       ┃
┃  │                                                                      │       ┃
┃  │  브라우저 (오케스트레이터)                                             │       ┃
┃  │  └─ 10단계 순차 API 호출로 분석을 지휘                                │       ┃
┃  │     각 스텝 < 30초 → Vercel 60초 타임아웃 회피                        │       ┃
┃  │                                                                      │       ┃
┃  │  서버 (API Routes)                                                   │       ┃
┃  │  ├─ Node.js Runtime: 데이터 수집, 캐시 R/W                           │       ┃
┃  │  └─ Edge Runtime: LLM 스트리밍 (최대 300초)                           │       ┃
┃  │                                                                      │       ┃
┃  │  밸류에이션 엔진 (순수 TypeScript)                                    │       ┃
┃  │  └─ DCF / RIM / Comparable — LLM이 아닌 코드로 계산                   │       ┃
┃  │                                                                      │       ┃
┃  └──────────────────────────────────────────────────────────────────────┘       ┃
┃                                                                                 ┃
┗━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
        │           │           │          │
        ▼           ▼           ▼          ▼
  ┌───────────┐┌───────────┐┌────────┐┌───────────┐
  │ Financial ││   News    ││  LLM   ││ Database  │
  │   Data    ││           ││ Engine ││  & Auth   │
  │           ││           ││        ││           │
  │ FMP Free  ││ Finnhub   ││ Google ││ Supabase  │
  │ + EDGAR   ││ Free      ││ Gemini ││ Free      │
  │[External] ││[External] ││[Extern]││[External] │
  └───────────┘└───────────┘└────────┘└───────────┘
```

---

## 2. External Systems

### 2.1 Financial Data — FMP Free + SEC EDGAR

이 두 소스를 조합해 재무 데이터의 폭과 깊이를 모두 확보한다.

```
┌──────────────────────────────────────────────────────────────┐
│  Financial Data Layer                                        │
│                                                              │
│  ┌──────────────────────────────┐  ┌──────────────────────┐ │
│  │  Financial Modeling Prep     │  │  SEC EDGAR            │ │
│  │  (FMP Free Tier)             │  │  (완전 무료 공공 API)  │ │
│  │                              │  │                       │ │
│  │  제한: 250 requests/day      │  │  제한: 10 req/sec     │ │
│  │  인증: API Key (무료 발급)    │  │  인증: User-Agent만   │ │
│  │                              │  │                       │ │
│  │  제공 데이터:                 │  │  제공 데이터:          │ │
│  │  ├─ Company Profile          │  │  ├─ XBRL 재무데이터   │ │
│  │  ├─ Income Statement (5yr)   │  │  ├─ 10-K (연간보고서) │ │
│  │  ├─ Balance Sheet (5yr)      │  │  ├─ 10-Q (분기보고서) │ │
│  │  ├─ Cash Flow Statement (5yr)│  │  ├─ 8-K (수시공시)   │ │
│  │  ├─ Financial Ratios         │  │  └─ Company Facts    │ │
│  │  ├─ Stock Quote (현재가)      │  │      (CIK 기반)      │ │
│  │  ├─ Historical Prices        │  │                       │ │
│  │  └─ Peers List               │  │  역할:                │ │
│  │                              │  │  FMP 할당량 초과 시   │ │
│  │  역할:                        │  │  1차 폴백 소스.       │ │
│  │  정형 재무 데이터의 1차 소스.  │  │  리스크 팩터(Item 1A) │ │
│  │  프로필, 시세, 비율 등        │  │  같은 비정형 데이터도 │ │
│  │  편의 데이터 제공.            │  │  여기서 추출.         │ │
│  │                              │  │                       │ │
│  └──────────────────────────────┘  └──────────────────────┘ │
│                                                              │
│  1회 분석 시 FMP ~8 requests 소비                             │
│  일일 용량: ~31 고유 종목 (캐시 HIT 시 0 소비)                │
│                                                              │
│  용도:                                                       │
│  ├─ 종합 리포트의 재무 요약 섹션                              │
│  ├─ 투자 대가 체크리스트의 정량 항목 (ROE, PER, 부채비율 등)  │
│  ├─ DCF/RIM 모델의 입력 데이터                                │
│  ├─ 경쟁사 비교 분석                                         │
│  └─ 현재가 vs 적정주가 비교                                   │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 News — Finnhub Free

```
┌──────────────────────────────────────────────────────────────┐
│  Finnhub News API                                            │
│  [External System]                                           │
│                                                              │
│  제한: 60 calls/min (Free Tier)                              │
│  인증: API Key (무료 발급)                                    │
│                                                              │
│  제공 데이터:                                                 │
│  ├─ 종목별 최신 뉴스 (최근 30일)                              │
│  ├─ 헤드라인 + 요약 + 소스 + URL                              │
│  ├─ 발행일시                                                 │
│  └─ 카테고리 태그                                             │
│                                                              │
│  우리 시스템에서의 처리:                                       │
│  ├─ LLM이 뉴스를 분석 → 긍정/부정/중립 분류                   │
│  ├─ LLM이 주가 영향도 판단 (High / Medium / Low)              │
│  └─ 종합 리포트와 투자자 분석의 "최신 이벤트" 컨텍스트로 주입  │
│                                                              │
│  용도:                                                       │
│  ├─ 종합 리포트의 뉴스 & 이벤트 섹션                          │
│  ├─ 투자 대가 분석의 최근 동향 반영                           │
│  └─ (향후) 뉴스 인텔리전스 탭의 센티먼트 차트                  │
└──────────────────────────────────────────────────────────────┘
```

### 2.3 LLM Engine — Google Gemini (LLMPort 추상화)

```
┌──────────────────────────────────────────────────────────────┐
│  Google Gemini via LLMPort (REST API 직접 호출)               │
│  [External System — 가장 핵심적인 의존성]                      │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Gemini 2.5 Flash  (메인 모델)                        │   │
│  │  제한: 10 RPM, 250 RPD, 250K TPM                     │   │
│  │  용도: 종합 리포트, 투자자 6인 분석, 밸류에이션 가정치  │   │
│  ├──────────────────────────────────────────────────────┤   │
│  │  Gemini 2.5 Flash-Lite  (경량 모델)                   │   │
│  │  제한: 15 RPM, 1K RPD, 250K TPM                      │   │
│  │  용도: 뉴스 요약, 검색 보조 등 단순 작업               │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  왜 Gemini인가:                                              │
│  ├─ 무료 tier가 가장 넉넉 (일 250회, 분당 10회)              │
│  ├─ 한국어 품질 양호                                         │
│  └─ LLMPort 추상화로 어댑터 교체만으로                        │
│     Claude / GPT-4o 등으로 즉시 전환 가능 (SDK 의존 없음)    │
│                                                              │
│  1회 전체 분석 = 8 LLM 호출:                                 │
│  ├─ 종합 리포트          ×1                                  │
│  ├─ 투자자 분석          ×6 (버핏,그레이엄,린치,달리오,       │
│  │                           그린블랫,피셔)                   │
│  └─ 밸류에이션 가정치     ×1                                  │
│                                                              │
│  일일 용량: 250 RPD ÷ 8 = ~31회 전체 분석                    │
└──────────────────────────────────────────────────────────────┘
```

### 2.4 Database & Auth — Supabase Free

```
┌──────────────────────────────────────────────────────────────┐
│  Supabase Free Tier                                          │
│  [External System — DB + Auth + 캐시 통합]                    │
│                                                              │
│  제한: 500MB DB, 1GB storage, 50K MAU                        │
│  별도 Redis 불필요 — PostgreSQL JSONB로 캐시 역할도 수행      │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  PostgreSQL                                          │   │
│  │  financial_data_cache, analyses, profiles,            │   │
│  │  watchlist, analysis_events                           │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Supabase Auth                                       │   │
│  │  └─ Google OAuth (향후)                               │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  자동정지 방지                                        │   │
│  │  └─ Vercel Cron (1개 무료)이 매일 keep-alive 쿼리     │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  용량 추정: ~120MB (500종목 캐시) → 500MB 한도 내 충분       │
└──────────────────────────────────────────────────────────────┘
```

---

## 3. Data Flow — 1회 분석 요청 시 (클라이언트 오케스트레이션)

핵심 아키텍처 결정: **브라우저가 지휘자**.
단일 긴 서버 호출이 아닌, 10단계 순차 API 호출로 분할하여
Vercel 60초 타임아웃을 회피하고, 단계별 진행 UI를 자연스럽게 구현한다.

```
사용자: "AAPL 분석해줘"
         │
         ▼
┌──────────────────────────────────────────────────────────────────┐
│  Browser (분석 오케스트레이터)                                     │
│                                                                  │
│  Step 0:  GET  /api/cache/AAPL        ← 캐시 확인                │
│  Step 1:  POST /api/analyze/collect   ← 데이터 수집              │
│  Step 2:  POST /api/analyze/report    ← 종합 리포트 (스트리밍)    │
│  Step 3~8: POST /api/analyze/investor/{id} ← 투자자 6명 (순차)   │
│  Step 9:  POST /api/analyze/valuation ← 밸류에이션 (스트리밍)     │
│  Step 10: POST /api/analyze/save      ← 결과 캐싱                │
│                                                                  │
│  총 소요: 약 2~3분                                                │
│  총 LLM 호출: 8회                                                │
└──────────────────────────────────────────────────────────────────┘
```

---

## 4. 비용 추정

| 항목 | 월 비용 | Free Tier 한도 |
|------|:------:|---------------|
| Vercel Hobby | $0 | 100GB BW, 서버리스 60s, Edge 30s |
| Supabase Free | $0 | 500MB DB, 50K MAU, 1GB storage |
| Google Gemini | $0 | 10 RPM, 250 RPD, 250K TPM |
| FMP Free | $0 | 250 requests/day |
| Finnhub Free | $0 | 60 calls/min |
| SEC EDGAR | $0 | 무제한 (공공 API) |
| **합계** | **$0** | **일 ~31회 전체 분석 가능** |

---

## 5. 핵심 아키텍처 결정

| 결정 사항 | 선택 | 이유 |
|----------|------|------|
| 클라이언트 vs 서버 오케스트레이션 | 클라이언트 (브라우저) | Vercel 60초 타임아웃 회피 |
| Edge vs Node.js | LLM = Edge, 데이터 = Node.js | Edge 스트리밍 최대 300초 |
| LLM 선택 | Gemini 2.5 Flash (Free) | 무료 중 가장 넉넉, LLMPort로 교체 1줄 |
| 투자자 분석 실행 | 순차 | 10 RPM 준수, 단계별 UX |
| 밸류에이션 계산 | TypeScript | LLM은 가정치만, 계산은 코드 |
| 캐싱 | Supabase JSONB | Redis 없이 통합 |
| 모노리스 vs MSA | Next.js 모노리스 | MVP 복잡도 최소화 |
